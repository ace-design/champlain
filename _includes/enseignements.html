{% assign enseignements = site.enseignements | sort: 'date' | reverse %}
{% assign year = 2000 %}

<div class="support" style="padding-bottom: 0; padding-top: 0">
    <div class="support-info">
        <h3 style="margin: 0"><i class="fa fa-search"></i></h3><input type="text" id="search-input" placeholder="Vous recherchez un enseignement ?" class="search-bar" style="margin-left: 0.5em">
    </div>
</div>
<div class="support" style="padding-bottom: 0; padding-top: 0">
    <ul id="results-container" style="margin: 0"></ul>
</div>

<section>
    <!-- Script pointing to jekyll-search.js -->
    <script src="{{ "/assets/js/vendor/simple-jekyll-search.min.js" | relative_url }}" type="text/javascript"></script>

    <script type="text/javascript">
        SimpleJekyllSearch({
            searchInput: document.getElementById('search-input'),
            resultsContainer: document.getElementById('results-container'),
            json: '{{ "/assets/data/search_enseignements.json" | relative_url }}',
            searchResultTemplate: '<div class="support-teaser"><span><header><h1><a href="{url}">{sigle} - {title}</a></h1><div class="support-info"><p class="label">Par</p><p class="souslabel">{auteurs}</p></div><div class="support-info"><p class="label">A</p><p class="souslabel">{institution}</p><p class="souslabel">{composante}</p></div><div class="support-info"><p class="label">Niveau</p><p class="souslabel">{level}</p></div><div class="support-info"><p class="label">Domaines de compétence visés</p><br/><p class="souslabel">{competences}</p></header></span></div>',
            noResultsText: 'No results found',
            limit: 10,
            fuzzy: false,
            exclude: []
        })

    </script>
</section>



<div class="support" style="padding-bottom: 0;">
    <div class="outer-div">
        <div class="inner-div" style="margin-bottom: 0;">
            <select id="selectAuthors" class="">
                <option value="choose" selected>Sélectionnez un enseignant</option>
                {% assign current_team = site.data.authors | where: "position","equipe" %}
                {% for member in current_team %}
                <option value="{{ member.name }}">{{ member.name }}</option>
                {% endfor %}
            </select>

            <select id="selectInstitution" class="">
                <option value="choose" selected>Sélectionnez une institution</option>
                <option value="Université Côte d'Azur" data-icon="" class="rounded-circle">Université Côte d'Azur</option>
                <option value="Université du Québec à Montréal" data-icon="" class="rounded-circle">Université du Québec à Montréal</option>
            </select>

            <select id="selectNiveau" class="">
                <option value="choose" selected>Sélectionnez un niveau</option>
                <option value="Licence/Bachelor">Licence/Bachelor</option>
                <option value="Master/Maîtrise">Master/Maîtrise</option>
                <option value="Doctorat">Doctorat</option>
            </select>

            <select id="selectCompetence" class="">
                <option value="choose" selected>Sélectionnez une compétence</option>
                <option value="IHM">IHM</option>
                <option value="IA">IA</option>
                <option value="GL">GL</option>
                <option value="IO">IO</option>
                <option value="UTILISATEUR">UTILISATEUR</option>
                <option value="TECHNO">TECHNO</option>
            </select>


            <button class="btn-save" id="save">Filtrer</button> 
        </div>
    </div>
</div>

<div class="support" style="padding-top: 0" id="enseignements">
    {% for enseignement in enseignements %}
    {% assign current_year = enseignement.date | date: "%Y" %}
    {% assign next_year = enseignement.date | date: "%Y" | plus: '1' %}
    {% if year != current_year  %}
    <h2>{{ current_year }} - {{ next_year }}</h2>
    {% assign year = current_year %}
    {% endif %}

    <div class="support-teaser">
        <span>
            <header>
                <h1><a href="{{ enseignement.url | relative_url }}">{{ enseignement.sigle }} - {{ enseignement.title }}</a></h1>
                {% include enseignement_info.html item=enseignement %}
            </header>
        </span>
    </div>
    {% endfor %}
</div>


<script type="text/javascript">
    var objets = new Array();
    var enseignements = document.getElementById("enseignements");

    var save = document.getElementById("save");


    /// Filtre sur les auteurs 

    var auteurSelect = document.getElementById("selectAuthors");
    let auteurFiltre = "";
    auteurSelect.addEventListener("change", function() {
        if (auteurSelect.value == "choose") {
            auteurFiltre = "";
        } else {
            auteurFiltre = auteurSelect.value;
        }
    });


    /// Filtre sur les institutions 

    var institutionSelect = document.getElementById("selectInstitution");
    let institutionFiltre = "";
    institutionSelect.addEventListener("change", function() {
        if (institutionSelect.value == "choose") {
            institutionFiltre = "";
        } else {
            institutionFiltre = institutionSelect.value;
        }
    });


    /// Filtre sur le niveau 

    var niveauSelect = document.getElementById("selectNiveau");
    let niveauFiltre = "";
    niveauSelect.addEventListener("change", function() {
        if (niveauSelect.value == "choose") {
            niveauFiltre = "";
        } else {
            niveauFiltre = niveauSelect.value;
        }
    });


    /// Filtre sur les compétences  

    var competenceSelect = document.getElementById("selectCompetence");
    let competenceFiltre = "";
    competenceSelect.addEventListener("change", function() {
        if (competenceSelect.value == "choose") {
            competenceFiltre = "";
        } else {
            competenceFiltre = competenceSelect.value;
        }
    });


    save.addEventListener("click", function() {
        //// On récupère tous les enseignements en parcourant le DOM, si on les a pas déjà récupéré 

        if (objets.length == 0) {
            var recuperes = document.getElementById("enseignements");
            var annee = 2000;
            for (var i = 0; i < recuperes.children.length; i++) {
                if (recuperes.children[i].tagName == "H2") {
                    annee = recuperes.children[i].textContent.substring(0, 4);
                } else {
                    var enseignement = new Object();
                    enseignement.year = parseInt(annee);
                    enseignement.title = recuperes.children[i].children[0].children[0].children[0].children[0].textContent;
                    enseignement.url = recuperes.children[i].children[0].children[0].children[0].children[0].getAttribute("href");
                    enseignement.auteurs = new Array();
                    enseignement.institution = new Object();
                    enseignement.composante = "";

                    var infos = recuperes.children[i].getElementsByClassName("support-info")

                    for (var j = 0; j < infos[0].children.length; j++) {
                        var auteur = new Object();
                        if (infos[0].children[j].tagName == "A") {
                            /// RECUPERATION DE L'INSTITUTION ET DE LA COMPOSANTE 
                            if (infos[0].children[j].className == "institution") {
                                enseignement.institution.url = infos[0].children[j].getAttribute("href");
                                enseignement.institution.avatar = infos[0].children[j].children[0].children[0].getAttribute("src");
                                enseignement.institution.name = infos[0].children[j].children[0].getAttribute("aria-label");
                                if (j != infos[0].children.length - 1) {
                                    enseignement.composante = infos[0].children[j + 1].textContent;
                                }
                                j++;
                            }
                            /// RECUPERATION DES AUTEURS
                            else {
                                auteur.name = infos[0].children[j + 1].textContent;
                                auteur.url = infos[0].children[j].getAttribute("href");
                                auteur.avatar = infos[0].children[j].children[0].getAttribute("src");
                                j++;
                            }

                        } else {
                            auteur.name = infos[0].children[j].textContent;
                        }
                        enseignement.auteurs.push(auteur);
                    }


                    enseignement.niveau = infos[1].children[1].textContent;

                    var competences = "";
                    for (var j = 1; j < infos[2].children.length; j++) {
                        competences += infos[2].children[j].outerHTML;
                    }
                    enseignement.competences = competences;

                    objets.push(enseignement);
                }

            }
        }


        ///// REECRITURE DU DOM 

        var final = "";
        var year = 2000;

        for (var i = 0; i < objets.length; i++) {

            for (var j = 0; j < objets[i].auteurs.length; j++) {
                if ((objets[i].auteurs[j].name == auteurFiltre || auteurFiltre == "") && (objets[i].institution.name == institutionFiltre || institutionFiltre == "") && (objets[i].niveau == niveauFiltre || niveauFiltre == "") && (objets[i].competences.indexOf(competenceFiltre) != -1 || competenceFiltre == "")) {
                    var current_year = objets[i].year;
                    var next_year = objets[i].year + 1;
                    if (current_year != year) {
                        final += "<h2>" + current_year + " - " + next_year + "</h2>";
                        year = current_year;
                    }
                    final += "<div class=\"support-teaser\"><span><header><h1><a href=\"" + objets[i].url + "\">" + objets[i].title + "</a></h1>";

                    /// Gestion des auteurs 
                    final += "<div class=\"support-info\">";
                    for (var j = 0; j < objets[i].auteurs.length - 1; j++) {
                        if (objets[i].auteurs[j].url != null) {
                            final += "<a target = \"_blank\" href=\"" + objets[i].auteurs[j].url + "\"><img src=\"https://ace-design.github.io/champlain/" + objets[i].auteurs[j].avatar + "\"></a>";
                        }
                        final += "<p class=\"souslabel\">" + objets[i].auteurs[j].name + "</p>"
                    }

                    /// Gestion et l'institution et de la composante 
                    final += "<a target = \"_blank\" href=\"" + objets[i].institution.url + "\"><img src=\"https://ace-design.github.io/champlain/" + objets[i].institution.avatar + "\"></a>";
                    final += "<p class=\"souslabel\">" + objets[i].composante + "</p>";

                    final += "</div>";

                    /// Gestion du niveau 
                    final += "<div class=\"support-info\">";
                    final += "<p class=\"label\">Niveau</p><p class=\"souslabel\">" + objets[i].niveau + "</p>";
                    final += "</div>";

                    /// Gestion des compétences  
                    final += "<div class=\"support-info\">";
                    final += "<p class=\"label\">Domaines de compétence visés</p>" + objets[i].competences;
                    final += "</div>";

                    final += "</header></span></div>";
                }
            }


        }

        enseignements.innerHTML = final;

    });

</script>
